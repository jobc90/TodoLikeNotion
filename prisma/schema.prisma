// Notion-like Todo App - Prisma Schema
// Block 기반 문서 구조

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== Page (문서) ====================
model Page {
  id        String   @id @default(cuid())
  title     String   @default("Untitled")
  icon      String?  // 이모지 아이콘
  cover     String?  // 커버 이미지 경로
  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  blocks    Block[]
  tags      PageTag[]
  revisions Revision[]
}

// ==================== Block (블록 - 노션 핵심) ====================
model Block {
  id            String   @id @default(cuid())
  pageId        String
  parentBlockId String?  // null이면 페이지 루트 레벨
  type          String   // paragraph, heading1, heading2, heading3, todo, toggle, bullet, numbered
  props         String   @default("{}") // JSON: { text, checked, level, ... }
  plainText     String?  // 검색용 순수 텍스트
  order         Int      // 정렬 순서
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  page        Page    @relation(fields: [pageId], references: [id], onDelete: Cascade)
  parentBlock Block?  @relation("BlockHierarchy", fields: [parentBlockId], references: [id], onDelete: Cascade)
  children    Block[] @relation("BlockHierarchy")

  @@index([pageId])
  @@index([parentBlockId])
  @@index([order])
}

// ==================== Revision (버전 히스토리) ====================
model Revision {
  id        String   @id @default(cuid())
  pageId    String
  snapshot  String   // JSON: 페이지 전체 상태 스냅샷
  createdAt DateTime @default(now())

  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([createdAt])
}

// ==================== Tag (태그) ====================
model Tag {
  id    String    @id @default(cuid())
  name  String    @unique
  color String?   // 태그 색상 (hex)

  pages PageTag[]
}

// ==================== PageTag (N:N 관계) ====================
model PageTag {
  pageId String
  tagId  String

  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([pageId, tagId])
}

// ==================== Attachment (첨부파일) ====================
model Attachment {
  id           String   @id @default(cuid())
  originalName String
  storagePath  String   // data/uploads/xxx
  mimeType     String
  size         Int
  blockId      String?  // 연결된 블록 ID (optional)
  createdAt    DateTime @default(now())

  @@index([blockId])
}

// ==================== Database (노션 데이터베이스) ====================
model Database {
  id        String   @id @default(cuid())
  pageId    String?  // 페이지에 임베드 시
  title     String   @default("Untitled")
  icon      String?  // 이모지 아이콘
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  properties Property[]
  rows       Row[]
  views      View[]

  @@index([pageId])
}

// ==================== Property (데이터베이스 컬럼) ====================
model Property {
  id         String   @id @default(cuid())
  databaseId String
  name       String
  type       String   // text, number, select, multi_select, date, checkbox, url
  options    String   @default("{}") // JSON: Select 옵션들 { options: [{ id, name, color }] }
  order      Int
  width      Int      @default(150)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  database Database @relation(fields: [databaseId], references: [id], onDelete: Cascade)
  cells    Cell[]

  @@index([databaseId])
  @@index([order])
}

// ==================== Row (데이터베이스 행) ====================
model Row {
  id         String   @id @default(cuid())
  databaseId String
  order      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  database Database @relation(fields: [databaseId], references: [id], onDelete: Cascade)
  cells    Cell[]

  @@index([databaseId])
  @@index([order])
}

// ==================== Cell (셀 데이터) ====================
model Cell {
  id         String   @id @default(cuid())
  rowId      String
  propertyId String
  value      String   @default("") // 타입별 값 저장 (JSON 또는 문자열)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  row      Row      @relation(fields: [rowId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([rowId, propertyId])
  @@index([rowId])
  @@index([propertyId])
}

// ==================== View (뷰 설정) ====================
model View {
  id         String   @id @default(cuid())
  databaseId String
  name       String   @default("기본 뷰")
  type       String   @default("table") // table, board, gallery
  config     String   @default("{}") // JSON: { filters, sorts, hiddenColumns, groupBy }
  order      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  database Database @relation(fields: [databaseId], references: [id], onDelete: Cascade)

  @@index([databaseId])
  @@index([order])
}
